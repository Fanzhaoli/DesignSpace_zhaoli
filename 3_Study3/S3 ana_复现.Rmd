---
title: "S3 ana_paper"
output: html_document
date: "2025-03-09"
---

```{r}
if (!requireNamespace('pacman', quietly = TRUE)) {
    install.packages('pacman')
}

pacman::p_load(
  tidyverse, purrr, bruceR, boot, lme4,
  ggplot2, ggdist, ggridges, patchwork
  )

# 不使用科学计数法显示
options(scipen = 999)

# 隐藏警告
options(warn = -1)
```

# Data Preprocessing
## Empirical data
### data
```{r}
# 定义修改数据类型的函数
convert_data_type_emp <- function(df) {
  df <- df %>% 
    dplyr::mutate(
      groupID = as.numeric(groupID),
      subjectID = as.numeric(subjectID),
      gender = as.numeric(gender),
      age = as.numeric(age),
      handedness = as.numeric(handedness),
      stage = as.character(stage),
      trialID = as.numeric(trialID),
      P = as.numeric(P),
      T = as.numeric(T),
      W = as.numeric(W),
      Shape = as.character(Shape),
      Label = as.character(Label),
      CorrectKey = as.character(CorrectKey),
      Response = as.character(Response),
      RT = as.numeric(RT),
      Correct = as.numeric(Correct)
      )
  return(df)
}
```

```{r}
# 将所有需要读取的数据文件名字保存到名为files的list
file_emp <- list.files(
  here::here("Study 3", "data", "emp_data"), 
  pattern = "EXP.*\\.csv$", 
  full.names = TRUE)
```

```{r}
df_emp <- data.frame() 
for (i in seq_along(file_emp)) {
  # 读取数据
  df <- read.csv(file_emp[i], header = TRUE) %>%  
    convert_data_type_emp() 
  # 合并数据
  df_emp <- dplyr::bind_rows(df_emp, df) 
}

# 删除临时变量
rm(df, file_emp, i)
```

```{r}
# 根据数据生成matchness变量
df_emp <- df_emp %>%
  filter(stage == "formal") %>%  #  & groupID != 7
  mutate(
    # 根据 subjectID 取余数来分配 pattern
    MatchKey = case_when(
      subjectID %% 4 == 1 ~ "f",
      subjectID %% 4 == 2 ~ "j",
      subjectID %% 4 == 3 ~ "j",
      subjectID %% 4 == 0 ~ "f",
      TRUE ~ NA_character_  # 如果有其他情况，设置为 NA
    ),
    # 判断是否匹配
    Matchness = ifelse(CorrectKey == MatchKey, "match", "mismatch"),
    T = T * 1000,
    W = W * 1000,
    RT_ms = RT * 1000
  )

# 生成变量，被试是否按键
df_emp$Press <- ifelse(!is.nan(df_emp$RT), 1, 0)  # NA反应
```

```{r}
# 按照 groupID 和 subjectID 排序
df_emp <- df_emp[order(df_emp$groupID, df_emp$subjectID, df_emp$trialID), ]

df_emp <- df_emp %>%
  group_by(groupID, subjectID) %>%
  mutate(block = rep(1:ceiling(n()/52), each = 52, length.out = n())) %>%
  ungroup()
```

```{r}
df_emp_match <- df_emp %>% 
  filter(Matchness == "match") %>%
  mutate(Type = "empirical") %>%
  select(groupID, subjectID, Type, block, trialID, P, T, W, Label, Press, Correct, RT, RT_ms)
```

### parameter
```{r}
paradata <- df_emp_match %>%
  filter(!is.na(RT)) %>%
  select(groupID, subjectID, Correct, RT, Label)

# 导出合并好的数据
bruceR::export(
  paradata, 
  file = here::here("Study 3", "data", "para_data.csv"))
```

```{r}
# 确保文件路径正确
file_path <- here::here("Study 3", "data", "fast dm", "estimates_0424.txt") # v_label_z.txt  

# 读取文件
para_emp <- read.table(file_path, header = TRUE, sep = ";", stringsAsFactors = FALSE) %>%
  mutate(
    groupID = as.numeric(gsub("\\D", "", sub("participant_(\\d+)_\\d+", "\\1", dataset))),
    subjectID = as.numeric(gsub("\\D", "", sub("participant_\\d+_(\\d+)", "\\1", dataset)))
  ) 
```

```{r}
para_emp_individual <- para_emp %>%
  mutate(
    v_diff = v_self - v_stranger
  )%>%
  select(groupID, subjectID, a, v_diff)
```

```{r}
para_emp_group <- para_emp %>%
  mutate(
    v_diff = v_self - v_stranger
  ) %>%
  group_by(groupID) %>%
  summarise(
    a = mean(a),
    v_diff = mean(v_diff),
    .groups = "drop"
  ) %>%
  select(groupID, a, v_diff)
```

```{r}
para_emp_long <- para_emp %>%
  pivot_longer(cols = c(v_self, v_stranger), 
               names_to = "label", 
               values_to = "v") %>% 
  mutate(label = recode(label, 
                        v_self = "self",
                        v_stranger = "stranger")) %>%
  select(groupID, subjectID, label, v)
```

### participant
```{r}
participant_individual <- df_emp %>%
  group_by(groupID, subjectID) %>%
  summarise(
    age = mean(age),
    gender = mean(gender),
    trials = n(),
    valid_trials = sum(Press == 1, na.rm = TRUE), 
    P = mean(P),
    T = mean(T),
    W = mean(W),
    .groups = "drop"
  ) %>%
  mutate(condition = paste("P=", P, ",T=", T, ",W=", W, sep=""),
         condition = ifelse(groupID == 7, paste(condition, "(nomask)", sep=" "), condition))
```

```{r}
participant_individual_match <- df_emp %>%
  filter(Matchness == "match") %>%
  mutate(Type = "empirical") %>%
  group_by(groupID, subjectID) %>%
  summarise(
    age = mean(age),
    gender = mean(gender),
    trials = n(),
    valid_trials = sum(Press == 1, na.rm = TRUE), 
    P = mean(P),
    T = mean(T),
    W = mean(W),
    .groups = "drop"
  ) %>%
  mutate(condition = paste("P=", P, ",T=", T, ",W=", W, sep=""),
         condition = ifelse(groupID == 7, paste(condition, "(nomask)", sep=" "), condition)) %>%
  select(condition, subjectID, trials, valid_trials)
```

```{r}
participant_group <- participant_individual %>%
  group_by(groupID) %>%
  summarise(
    age_mean = mean(age),
    age_sd = sd(age),
    total = n(),  # 总被试数
    female = sum(gender == 1, na.rm = TRUE),  # 女性被试数
    female_ratio = female / total,  # 女性被试比例
    trials = sum(trials, na.rm = TRUE), 
    pressed_trials = sum(valid_trials, na.rm = TRUE),
    P = mean(P),
    T = mean(T),
    W = mean(W),
    .groups = "drop"
  ) %>%
  mutate(condition = paste("P=", P, ",T=", T, ",W=", W, sep=""),
         condition = ifelse(groupID == 7, paste(condition, "(nomask)", sep=" "), condition)) %>%
  select(-P, -T, -W)

participant_group
```

## Simulated data模拟数据
### data
```{r}
# 定义修改数据类型的函数
convert_data_type_sim <- function(df) {
  df <- df %>% 
    dplyr::mutate(
      groupID = as.numeric(groupID),
      subjectID = as.numeric(subjectID),
      trialID = as.numeric(trialID),
      P = as.numeric(P),
      T = as.numeric(T),
      W = as.numeric(W),
      v = as.numeric(v),
      a = as.numeric(a),
      Label = as.character(Label),
      RT = as.numeric(RT)
      )
  return(df)
}
```

```{r}
# 将所有需要读取的数据文件名字保存到名为files的list
file_sim <- list.files(
  here::here("Study 3", "data", "sim_data", "250430"), 
  pattern = "d*\\.csv$", 
  full.names = TRUE)
```

```{r}
df_sim <- data.frame() 
for (i in seq_along(file_sim)) {
  # 读取数据
  df <- read.csv(file_sim[i], header = TRUE) 
  
  # 为每个文件添加groupID
  df$groupID <- i  # i就是根据文件的顺序分配的数字
  
  # 合并数据
  df_sim <- dplyr::bind_rows(df_sim, df)
}

# 删除临时变量
rm(df, file_sim, i)
```

```{r}
df_sim <- df_sim %>% 
  convert_data_type_sim() %>%
  mutate(
    RT_ms = RT * 1000,  # 将RT转为毫秒
    Correct = response, 
    Type = "simulated", # 新建type列，值为"simulated"
    Press = 1
    ) %>%  
  select(groupID, subjectID, Type, trialID, P, T, W, Label, a, v, Press, Correct, RT, RT_ms)
```

### parameter
```{r}
para_sim <- df_sim %>%
  select(groupID, subjectID, Label, a, v) %>%
  rename(label = Label)
```

```{r}
para_sim_group <- para_sim %>%
  group_by(groupID, label) %>%
    summarise(
    v = mean(v),
    a = mean(a),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = label, 
    values_from = v
  ) %>%
  rename(
    v_self = self,
    v_stranger = stranger
  ) %>%
  mutate(
    v_diff = v_self - v_stranger
  )
```

```{r}
para_sim_group_long <- para_sim %>%
  group_by(groupID, label) %>%
    summarise(
    v = mean(v),
    a = mean(a),
    .groups = "drop"
  )
```

## Combine合并
```{r}
df_combined <- bind_rows(df_emp_match, df_sim) %>%
  mutate(uniqueID = paste(Type, groupID, subjectID, sep = "_")) %>%
  group_by(groupID) %>%
  mutate(Condition = paste("P=", P, ",T=", T, ",W=", W, sep=""),
         Condition = ifelse(groupID == 7, paste(Condition, "(nomask)", sep=" "), Condition)) %>%
  ungroup()
```

```{r}
df_group <- df_combined %>%
  group_by(groupID, Type, Label) %>%
  summarise(
    n = n(),
    mean_RT = mean(RT_ms, na.rm = TRUE),
    sd_RT = sd(RT_ms, na.rm = TRUE),
    mean_ACC = mean(Correct == 1, na.rm = TRUE),
    sd_ACC = sd(Correct == 1, na.rm = TRUE),
    P = mean(P),
    T = mean(T),
    W = mean(W),
    .groups = "drop"
    ) %>%
  group_by(groupID) %>%
  mutate(Condition = paste("P=", P, ",T=", T, ",W=", W, sep=""),
         Condition = ifelse(groupID == 7, paste(Condition, "(nomask)", sep=" "), Condition),
         uniqueID = paste(Type, groupID, sep = "_")) %>%
  ungroup()
```

```{r}
df_individual <- df_combined %>%
  group_by(groupID, subjectID, Type, Label) %>%
  summarise(
    n = n(),
    mean_RT = mean(RT_ms, na.rm = TRUE),
    sd_RT = sd(RT_ms, na.rm = TRUE),
    mean_ACC = mean(Correct == 1, na.rm = TRUE),
    sd_ACC = sd(Correct == 1, na.rm = TRUE),
    P = mean(P),
    T = mean(T),
    W = mean(W),
    .groups = "drop"
    ) %>%
  group_by(groupID) %>%
  mutate(Condition = paste("P=", P, ",T=", T, ",W=", W, sep=""),
         Condition = ifelse(groupID == 7, paste(Condition, "(nomask)", sep=" "), Condition),
         uniqueID = paste(Type, groupID, subjectID, sep = "_")) %>%
  ungroup() %>%
  mutate(conds = case_when(Label == "self" & Type == "empirical" ~ "0.88",
                           Label == "stranger" & Type == "empirical" ~ "1.12",
                           Label == "self" & Type == "simulated" ~ "1.88",
                           Label == "stranger" & Type == "simulated" ~ "2.12"),
         conds = as.numeric(conds))
```

```{r}
Condition_order <- c("P=0,T=30,W=300", "P=0,T=30,W=600", "P=120,T=30,W=600",
                     "P=120,T=80,W=600","P=8,T=100,W=1100", "P=120,T=500,W=1500")

df_group$Condition <- factor(df_group$Condition, levels = Condition_order)
df_individual$Condition <- factor(df_individual$Condition, levels = Condition_order)
```

```{r}
# 导出合并好的数据
bruceR::export(
  df_combined, 
  file = here::here("Study 3", "data", "data_raw.csv"))
```

## Cohen's d of RT and ACC
### group
```{r}
df_group_wide <- df_group  %>%
  pivot_wider(
    id_cols = uniqueID,  
    names_from = Label,         # 将 Label 作为列名的一部分
    values_from = c(mean_RT, sd_RT, mean_ACC, sd_ACC, n)  # 转换的列
  ) %>%
  left_join(df_group %>%
              select(uniqueID, Condition, Type, groupID) %>%
              distinct(), by = "uniqueID")  # 保留 condition 列
```

```{r}
# 分组整体: 计算 Cohen's d
df_group_wide <- df_group_wide %>%
  mutate(
    # RT 的 Cohen's d: stranger - self,值越大SPE越大
    cohen_d_RT = ifelse(
      !is.na(mean_RT_self) & !is.na(mean_RT_stranger),
      (mean_RT_stranger - mean_RT_self) / 
      sqrt(((n_stranger - 1) * sd_RT_stranger^2 + (n_self - 1) * sd_RT_self^2) / 
           (n_self + n_stranger - 2)),
      NA
    ),
    RT_diff = ifelse(
      !is.na(mean_RT_self) & !is.na(mean_RT_stranger),
      mean_RT_stranger - mean_RT_self,
      NA
    ),
    
    # ACC 的 Cohen's d: self - stranger,值越大SPE越大
    cohen_d_ACC = ifelse(
      !is.na(mean_ACC_self) & !is.na(mean_ACC_stranger),
      (mean_ACC_self - mean_ACC_stranger) / 
      sqrt(((n_self - 1) * sd_ACC_self^2 + (n_stranger - 1) * sd_ACC_stranger^2) / 
           (n_self + n_stranger - 2)),
      NA
    ),
    ACC_diff = ifelse(
      !is.na(mean_ACC_self) & !is.na(mean_ACC_stranger),
      mean_ACC_self - mean_ACC_stranger,
      NA
    )
  )
```

### individual
```{r}
df_individual_wide <- df_individual  %>%
  pivot_wider(
    id_cols = uniqueID,  
    names_from = Label,         # 将 Label 作为列名的一部分
    values_from = c(mean_RT, sd_RT, mean_ACC, sd_ACC, n)  # 转换的列
  ) %>%
  left_join(df_individual %>%
              select(uniqueID, Condition, Type, groupID, subjectID) %>%
              distinct(), by = "uniqueID")  # 保留 condition 列
```

```{r}
# 分组个人: 计算 Cohen's d
df_individual_wide <- df_individual_wide %>%
  mutate(
    # RT 的 Cohen's d: stranger - self,值越大SPE越大
    S_RT = ifelse(
      !is.na(mean_RT_self) & !is.na(mean_RT_stranger),
      sqrt(((n_stranger - 1) * sd_RT_stranger^2 + (n_self - 1) * sd_RT_self^2) / 
           (n_self + n_stranger - 2)),
      NA
    ),
    cohen_d_RT = ifelse(
      !is.na(mean_RT_self) & !is.na(mean_RT_stranger),
      (mean_RT_stranger - mean_RT_self) / 
      sqrt(((n_stranger - 1) * sd_RT_stranger^2 + (n_self - 1) * sd_RT_self^2) / 
           (n_self + n_stranger - 2)),
      NA
    ),
    diff_RT = ifelse(
      !is.na(mean_RT_self) & !is.na(mean_RT_stranger),
      mean_RT_stranger - mean_RT_self,
      NA
    ),
    
    # ACC 的 Cohen's d: self - stranger,值越大SPE越大
    S_ACC = ifelse(
      !is.na(mean_ACC_self) & !is.na(mean_ACC_stranger),
      sqrt(((n_self - 1) * sd_ACC_self^2 + (n_stranger - 1) * sd_ACC_stranger^2) / 
           (n_self + n_stranger - 2)),
      NA
    ),
    cohen_d_ACC = ifelse(
      !is.na(mean_ACC_self) & !is.na(mean_ACC_stranger),
      (mean_ACC_self - mean_ACC_stranger) / 
      sqrt(((n_self - 1) * sd_ACC_self^2 + (n_stranger - 1) * sd_ACC_stranger^2) / 
           (n_self + n_stranger - 2)),
      NA
    ),
    diff_ACC = ifelse(
      !is.na(mean_ACC_self) & !is.na(mean_ACC_stranger),
      mean_ACC_self - mean_ACC_stranger,
      NA
    )
  )
```

# Description 排除第七组（无掩蔽组）
```{r}
df_group_mask <- df_group %>%
  filter(groupID != 7)

df_individual_mask <- df_individual %>%
  filter(groupID != 7)

df_individual_mask_wide <- df_individual_wide %>%
  filter(groupID != 7)
```

## RT
```{r}
b1 <- ggplot(df_group_mask, 
       aes(x = Label, y = mean_RT, color = Type, shape = Type)) +
  geom_point(size = 3.5, position = position_dodge(0.5)) +  # 绘制点
  geom_errorbar(aes(ymin = mean_RT - sd_RT, ymax = mean_RT + sd_RT),
                width = .1,
                position = position_dodge(0.5)) +  # 添加误差条
  labs(x = "Type", y = "Reaction Time") +
  facet_wrap(~ Condition, nrow = 2) +  # 按 Condition 分面  , scales = "free_y"
  papaja::theme_apa() +
  scale_color_manual(values = c("simulated" = "#12264f", "empirical" = "#a72126"))  # 自定义颜色

b1
```

```{r}
RT <- b1 +
  geom_jitter(
    data = df_individual_mask,
    aes(x = Label, y = mean_RT, color = Type, shape = Type),
    size = 2.5, alpha = 0.3, 
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.5)) +  # 添加jitter和dodge
  labs(x = "Design", y = "RT") +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"), # x轴标题字体大小
    axis.title.y = element_text(size = 20, face = "bold", color = "black"), # y轴标题字体大小
    axis.text.x = element_text(size = 19, face = "bold", color = "black"),  # x轴刻度标签字体大小
    axis.text.y = element_text(size = 19, face = "bold", color = "black"),  # y轴刻度标签字体大小
    strip.text = element_text(size = 18, face = "bold", color = "black"),   # 分面标签字体大小
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

RT
```

```{r}
ggsave("RT.png", #保存图片到本地
       plot = RT, 
       width = 11, 
       height = 7, 
       dpi = 300)
```

## ACC
```{r}
b2 <- ggplot(df_group_mask, 
             aes(x = Label, y = mean_ACC, color = Type, shape = Type)) +
  geom_point(size = 3.5,
             position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = mean_ACC - sd_ACC,
                    ymax = mean_ACC + sd_ACC),
                width = .1,
                position = position_dodge(0.5)) +
  labs(x = "Matchness", y = "ACC") +
  facet_wrap(~ Condition, nrow = 2) +
  papaja::theme_apa() +
  scale_color_manual(values = c("simulated" = "#12264f", "empirical" = "#a72126"))  # 自定义颜色

b2
```

```{r}
ACC <- b2 +
  geom_jitter(
    data = df_individual_mask,
    aes(x = Label, y = mean_ACC, color = Type, shape = Type),
    size = 2.5, alpha = 0.3, 
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.5)) +  # 添加jitter和dodge
  labs(x = "Design", y = "ACC") +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"), # x轴标题字体大小
    axis.title.y = element_text(size = 20, face = "bold", color = "black"), # y轴标题字体大小
    axis.text.x = element_text(size = 19, face = "bold", color = "black"),  # x轴刻度标签字体大小
    axis.text.y = element_text(size = 19, face = "bold", color = "black"),  # y轴刻度标签字体大小
    strip.text = element_text(size = 18, face = "bold", color = "black"),   # 分面标签字体大小
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

ACC
```

```{r}
ggsave("ACC.png", 
       plot = ACC, 
       width = 11, 
       height = 7, 
       dpi = 300)
```

## Cohen's d for RT
```{r}
cd_RT <- ggplot(df_individual_mask_wide, 
                aes(x = Condition, y = cohen_d_RT, color = Type, shape = Type)) +
  geom_boxplot(aes(fill = Type), alpha = 0.2, outlier.shape = NA) +  # 绘制箱线图并调整透明度
  geom_jitter(size = 2.5, alpha = 0.5, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75)) +  # 调整点的位置
  labs(x = "Design", y = "cohen's d RT") +
  papaja::theme_apa() +
  scale_color_manual(values = c("simulated" = "#12264f", "empirical" = "#a72126")) +  # 设置点的颜色
  scale_fill_manual(values = c("simulated" = "#12264f", "empirical" = "#a72126")) +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

cd_RT
```

```{r}
ggsave("cd_RT.png", 
       plot = cd_RT, 
       width = 14, 
       height = 5, 
       dpi = 300)
```

## Cohen's d for ACC
```{r}
cd_ACC <- ggplot(df_individual_mask_wide, 
                 aes(x = Condition, y = cohen_d_ACC, color = Type, shape = Type)) +
  geom_boxplot(aes(fill = Type), alpha = 0.2, outlier.shape = NA) +  # 绘制箱线图并调整透明度
  geom_jitter(size = 2.5, alpha = 0.5, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75)) +  # 调整点的位置
  labs(x = "Design", y = "cohen's d ACC") +
  papaja::theme_apa() +
  scale_color_manual(values = c("simulated" = "#12264f", "empirical" = "#a72126")) +  # 设置点的颜色
  scale_fill_manual(values = c("simulated" = "#12264f", "empirical" = "#a72126")) +  # 设置箱线图的填充颜色
  scale_y_continuous(breaks = seq(-1, 1.5, by = 0.2)) +  # 设置y轴的刻度为每次增长0.1
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

cd_ACC
```

```{r}
ggsave("cd_ACC.png", 
       plot = cd_ACC, 
       width = 14, 
       height = 5, 
       dpi = 300)
```

```{r}
# 拼图
combined_plot1 <- RT / ACC +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")

# 显示图
combined_plot1
```

```{r}
ggsave("combined_plot1.png", 
       plot = combined_plot1, 
       width = 12, 
       height = 11, 
       dpi = 300)
```

```{r}
# 拼图
combined_plot2 <- cd_RT / cd_ACC +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")

# 显示图
combined_plot2
```

```{r}
ggsave("combined_plot2.png", 
       plot = combined_plot2, 
       width = 19, 
       height = 11, 
       dpi = 300)
```

# Bootstrap(trial level)抽样
```{r}
emp_bootstrap <- df_emp_match %>%
  filter(!is.na(RT_ms) & groupID != 7) %>% 
  mutate(
    uniqueID = paste(groupID, subjectID, Label, sep = "_"),
    subjID = paste(groupID, subjectID, sep = "_")
    )
```

## Return Cohen's d
### RT
```{r}
# bootstrap过程  #传统 Bootstrap（按试次整体重采样）
set.seed(522)

emp_bootstrap_cd_RT <- lapply(split(emp_bootstrap, emp_bootstrap$subjID), function(subj_data) {
  boot(data = as.data.frame(subj_data), statistic = function(data, indices) {
    
    # 获取每个被试的数据
    sampled_data <- data[indices, ]
    
    # 按照 label 分组 (self 和 stranger)
    group_self <- sampled_data[sampled_data$Label == "self", "RT_ms"]
    group_stranger <- sampled_data[sampled_data$Label == "stranger", "RT_ms"]
    
    # 计算 mean_RT 和 sd_RT
    mean_RT_self <- mean(group_self, na.rm = TRUE)
    mean_RT_stranger <- mean(group_stranger, na.rm = TRUE)
    sd_RT_self <- sd(group_self, na.rm = TRUE)
    sd_RT_stranger <- sd(group_stranger, na.rm = TRUE)
    
    # 计算 Cohen's d RT: stranger - self
    d <- (mean_RT_stranger - mean_RT_self) / 
      sqrt(((length(group_stranger) - 1) * sd_RT_stranger^2 + (length(group_self) - 1) * sd_RT_self^2) / (length(group_self) + length(group_stranger) - 2))
    
    return(c(mean_RT_self = mean_RT_self, mean_RT_stranger = mean_RT_stranger, cohen_d = d))
  }, R = 5000)
})

# emp_bootstrap_cd_RT
```

```{r}
#优化版 Bootstrap（self/stranger 独立重采样，推荐）
set.seed(522)

emp_bootstrap_cd_RT <- lapply(split(emp_bootstrap, emp_bootstrap$subjID), function(subj_data) {
  boot(data = as.data.frame(subj_data), statistic = function(data, indices_unused) {
    
    # 分别提取 self 和 stranger 原始数据
    data_self <- data[data$Label == "self", ]
    data_stranger <- data[data$Label == "stranger", ]
    
    # 对 self 和 stranger 分别进行有放回的重采样
    sampled_self <- data_self[sample(1:nrow(data_self), size = nrow(data_self), replace = TRUE), "RT_ms"]
    sampled_stranger <- data_stranger[sample(1:nrow(data_stranger), size = nrow(data_stranger), replace = TRUE), "RT_ms"]
    
    # 计算均值和标准差
    mean_RT_self <- mean(sampled_self, na.rm = TRUE)
    mean_RT_stranger <- mean(sampled_stranger, na.rm = TRUE)
    sd_RT_self <- sd(sampled_self, na.rm = TRUE)
    sd_RT_stranger <- sd(sampled_stranger, na.rm = TRUE)
    
    # 计算 pooled SD 和 Cohen's d
    d <- (mean_RT_stranger - mean_RT_self) /
      sqrt(((length(sampled_stranger) - 1) * sd_RT_stranger^2 + 
            (length(sampled_self) - 1) * sd_RT_self^2) /
           (length(sampled_self) + length(sampled_stranger) - 2))
    
    return(c(mean_RT_self = mean_RT_self, mean_RT_stranger = mean_RT_stranger, cohen_d = d))
  }, R = 5000)
})
```

```{r}
# 提取 bootstrap 结果 + BCa 95% CI
emp_bootstrap_cd_RT_df <- do.call(rbind, lapply(seq_along(emp_bootstrap_cd_RT), function(i) {
  boot_obj <- emp_bootstrap_cd_RT[[i]]
  subj_id <- names(emp_bootstrap_cd_RT)[i]
  
  # 提取 95% CI for cohen_d
  ci <- tryCatch({
    boot.ci(boot_obj, type = "perc", index = 3)$perc[4:5]
  }, error = function(e) c(NA, NA))  # 防止个别被试失败（例如方差为0）

  # 每次抽样的结果
  df <- as.data.frame(boot_obj$t) %>%
    setNames(c("mean_RT_self", "mean_RT_stranger", "Cohen_d_RT")) %>%
    mutate(
      d_lower = ci[1],
      d_upper = ci[2],
      subjID = subj_id
    )
  return(df)
}))

# 拆分 'subjID' 为 'groupID' 和 'subjectID'
emp_bootstrap_cd_RT_df <- emp_bootstrap_cd_RT_df %>%
  separate(subjID, into = c("groupID", "subjectID"), sep = "_", remove = FALSE) %>%
  arrange(subjID)
```

```{r}
# 每个 group 的被试 ID
group_ids <- unique(emp_bootstrap_cd_RT_df$groupID)

group_bootstrap_RT <- lapply(group_ids, function(gid) {
  group_data <- emp_bootstrap_cd_RT_df %>% filter(groupID == gid)
  
  # 每个 subject 对应的 bootstrap Cohen's d 分布
  subject_split <- split(group_data$Cohen_d_RT, group_data$subjectID)
  
  # 样本数量
  n_subjects <- length(subject_split)
  n_boot <- length(subject_split[[1]])  # 假设每人 5000 次
  
  # 创建群体效应分布：每次从每个被试的 d 分布中抽一个，求平均
  group_boot_d <- replicate(n_boot, {
    sampled_d <- sapply(subject_split, function(d_vec) sample(d_vec, 1))
    mean(sampled_d, na.rm = TRUE)
  })
  
  # 群体 Cohen's d 的均值和置信区间
  data.frame(
    groupID = gid,
    group_d_mean = mean(group_boot_d),
    group_d_lower = quantile(group_boot_d, 0.025),
    group_d_upper = quantile(group_boot_d, 0.975)
  )
})

group_bootstrap_RT_df <- bind_rows(group_bootstrap_RT)
```

### ACC
```{r}
# bootstrap过程
set.seed(522)

emp_bootstrap_cd_ACC <- lapply(split(emp_bootstrap, emp_bootstrap$subjID), function(subj_data) {
  boot(data = as.data.frame(subj_data), statistic = function(data, indices) {
    
    # 获取每个被试的数据
    sampled_data <- data[indices, ]
    
    # 按照 label 分组 (self 和 stranger)
    group_self <- sampled_data[sampled_data$Label == "self", "Correct"]
    group_stranger <- sampled_data[sampled_data$Label == "stranger", "Correct"]
    
    # 计算 mean_ACC 和 sd_ACC
    mean_ACC_self <- mean(group_self == 1, na.rm = TRUE)
    mean_ACC_stranger <- mean(group_stranger == 1, na.rm = TRUE)
    sd_ACC_self <- sd(group_self == 1, na.rm = TRUE)
    sd_ACC_stranger <- sd(group_stranger == 1, na.rm = TRUE)
    
    # 计算 Cohen's d ACC: self - stranger
    d <- (mean_ACC_self - mean_ACC_stranger) / 
      sqrt(((length(group_stranger) - 1) * sd_ACC_stranger^2 + (length(group_self) - 1) * sd_ACC_self^2) / 
           (length(group_self) + length(group_stranger) - 2))
    
    return(c(mean_ACC_self = mean_ACC_self, mean_ACC_stranger = mean_ACC_stranger, cohen_d = d))
  }, R = 5000)
})

# emp_bootstrap_cd_ACC
```

```{r}
set.seed(522)

emp_bootstrap_cd_ACC <- lapply(split(emp_bootstrap, emp_bootstrap$subjID), function(subj_data) {
  boot(data = as.data.frame(subj_data), statistic = function(data, indices_unused) {
    
    # 分别提取 self 和 stranger 原始数据
    data_self <- data[data$Label == "self", ]
    data_stranger <- data[data$Label == "stranger", ]
    
    # 分别有放回地重采样
    sampled_self <- data_self[sample(1:nrow(data_self), size = nrow(data_self), replace = TRUE), "Correct"]
    sampled_stranger <- data_stranger[sample(1:nrow(data_stranger), size = nrow(data_stranger), replace = TRUE), "Correct"]
    
    # 计算正确率（即等于 1 的比例）和标准差
    mean_ACC_self <- mean(sampled_self == 1, na.rm = TRUE)
    mean_ACC_stranger <- mean(sampled_stranger == 1, na.rm = TRUE)
    sd_ACC_self <- sd(sampled_self == 1, na.rm = TRUE)
    sd_ACC_stranger <- sd(sampled_stranger == 1, na.rm = TRUE)
    
    # 计算 Cohen's d（self - stranger）
    d <- (mean_ACC_self - mean_ACC_stranger) / 
      sqrt(((length(sampled_stranger) - 1) * sd_ACC_stranger^2 + 
            (length(sampled_self) - 1) * sd_ACC_self^2) /
           (length(sampled_self) + length(sampled_stranger) - 2))
    
    return(c(mean_ACC_self = mean_ACC_self, mean_ACC_stranger = mean_ACC_stranger, cohen_d = d))
  }, R = 5000)
})
```

```{r}
# 提取 bootstrap 结果 + BCa 95% CI
emp_bootstrap_cd_ACC_df <- do.call(rbind, lapply(seq_along(emp_bootstrap_cd_ACC), function(i) {
  boot_obj <- emp_bootstrap_cd_ACC[[i]]
  subj_id <- names(emp_bootstrap_cd_ACC)[i]
  
  # 提取 95% CI for cohen_d
  ci <- tryCatch({
    boot.ci(boot_obj, type = "perc", index = 3)$perc[4:5]
  }, error = function(e) c(NA, NA))  # 防止个别被试失败（例如方差为0）

  # 每次抽样的结果
  df <- as.data.frame(boot_obj$t) %>%
    setNames(c("mean_ACC_self", "mean_ACC_stranger", "Cohen_d_ACC")) %>%
    mutate(
      d_lower = ci[1],
      d_upper = ci[2],
      subjID = subj_id
    )
  return(df)
}))

# 拆分 'subjID' 为 'groupID' 和 'subjectID'
emp_bootstrap_cd_ACC_df <- emp_bootstrap_cd_ACC_df %>%
  separate(subjID, into = c("groupID", "subjectID"), sep = "_", remove = FALSE) %>%
  arrange(subjID)
```

```{r}
# 每个 group 的被试 ID
group_ids <- unique(emp_bootstrap_cd_ACC_df$groupID)

group_bootstrap_ACC <- lapply(group_ids, function(gid) {
  group_data <- emp_bootstrap_cd_ACC_df %>% filter(groupID == gid)
  
  # 每个 subject 对应的 bootstrap Cohen's d 分布
  subject_split <- split(group_data$Cohen_d_ACC, group_data$subjectID)
  
  # 样本数量
  n_subjects <- length(subject_split)
  n_boot <- length(subject_split[[1]])  # 每人 5000 次
  
  # 创建群体效应分布：每次从每个被试的 d 分布中抽一个，求平均
  group_boot_d <- replicate(n_boot, {
    sampled_d <- sapply(subject_split, function(d_vec) sample(d_vec, 1))
    mean(sampled_d, na.rm = TRUE)
  })
  
  # 群体 Cohen's d 的均值和置信区间
  data.frame(
    groupID = gid,
    group_d_mean = mean(group_boot_d),
    group_d_lower = quantile(group_boot_d, 0.025),
    group_d_upper = quantile(group_boot_d, 0.975)
  )
})

group_bootstrap_ACC_df <- bind_rows(group_bootstrap_ACC)
```

## Subject Distribution分布
```{r}
# 定义组标签
group_labels <- c(
  "1" = "P=0,T=30,W=300",
  "2" = "P=0,T=30,W=600",
  "3" = "P=120,T=30,W=600",
  "4" = "P=120,T=80,W=600",
  "5" = "P=8,T=100,W=1100",
  "6" = "P=120,T=500,W=1500"
)
```

### RT
```{r}
# data processing
emp_bootstrap_cd_RT_df <- emp_bootstrap_cd_RT_df %>%
  arrange(as.numeric(subjectID)) %>%
  mutate(
    subjectID = factor(subjectID, levels = unique(subjectID)),
    groupLabel = group_labels[as.character(groupID)],
    label = paste0("Subject ", subjectID)
  )

# 根据 subjID 分组
subject_list_RT <- split(emp_bootstrap_cd_RT_df, emp_bootstrap_cd_RT_df$subjID)

# 按 groupID 分组
emp_bootstrap_RT_list <- split(emp_bootstrap_cd_RT_df, emp_bootstrap_cd_RT_df$groupID)
```

```{r}
# 每个被试画 RT + d 分布
plot_list_RT <- lapply(subject_list_RT, function(df) {
  
  # 宽转长
  df_long <- df %>%
    pivot_longer(cols = c(mean_RT_self, mean_RT_stranger), names_to = "Label", values_to = "RT") %>%
    mutate(Label = ifelse(Label == "mean_RT_self", "self", "stranger"))
  
  # RT 密度图
  p_rt <- ggplot(df_long, aes(x = RT, fill = Label, color = Label)) +
    geom_density(alpha = 0.4) +
    scale_fill_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
    scale_color_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
    labs(title = paste0("RT Density - ", unique(df$subjID), " (", unique(df$groupLabel), ")"),
         x = "RT (ms)", y = "Density") +
    papaja::theme_apa()
  
  # Cohen's d 分布图
  p_d <- ggplot(df, aes(x = Cohen_d_RT)) +
    geom_density(fill = "#9b8ea9", alpha = 0.5) +
    geom_vline(aes(xintercept = d_lower), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = d_upper), color = "red", linetype = "dashed") +
    labs(title = paste0("Cohen's d Bootstrap - ", unique(df$subjID)),
         x = "Cohen's d", y = "Density") +
    papaja::theme_apa()
  
  # 合并图
  p_rt + p_d
})

# 举例看第一个被试
plot_list_RT[[1]]
```

```{r}
# 每组按被试分面：Cohen's d 分布
plot_RT_d <- lapply(emp_bootstrap_RT_list, function(df) {
  
  df <- df %>%
    mutate(groupLabel = group_labels[as.character(groupID)]) %>%
    mutate(label = paste0("Subject ", subjectID))
  
  ggplot(df, aes(x = Cohen_d_RT)) +
    geom_density(fill = "steelblue", alpha = 0.5) +
    geom_vline(aes(xintercept = d_lower), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = d_upper), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = mean(Cohen_d_RT)), color = "black", linetype = "solid") +
    facet_wrap(~ subjectID, nrow = 2, scales = "fixed", labeller = labeller(subjectID = setNames(df$label, df$subjectID))) +
    labs(x = "Cohen's d RT", y = "Density", title = paste0("Group: ", unique(df$groupLabel))) +
    papaja::theme_apa()
})

# plot_RT_d
plot_RT_d[[4]]  #以第四组为例
```

```{r}
# 每组按被试分面： RT 分布 + 加均值线/点
plot_RT <- lapply(emp_bootstrap_RT_list, function(df) {
  
  # 加上 group label 和 subject label
  df <- df %>%
    mutate(groupLabel = group_labels[as.character(groupID)]) %>%
    mutate(label = paste0("Subject ", subjectID))
  
  # 宽转长格式 (RT部分)
  df_long <- df %>%
    pivot_longer(cols = c(mean_RT_self, mean_RT_stranger),
                 names_to = "Label",
                 values_to = "RT") %>%
    mutate(Label = ifelse(Label == "mean_RT_self", "self", "stranger"))
  
  # 提取个体均值（dashed线）
  df_lines <- df_long %>%
    group_by(groupID, subjectID, Label) %>%
    summarise(mean_RT = mean(RT, na.rm = TRUE), .groups = "drop")
  
  # 提取组均值（点）
  df_points <- df_long %>%
    group_by(groupID, Label) %>%
    summarise(mean_RT = mean(RT, na.rm = TRUE), .groups = "drop")
  
  # 画图
  p <- ggplot(df_long, aes(x = RT, fill = Label)) +
    geom_density(alpha = 0.4) +
    geom_vline(
      data = df_lines,
      aes(xintercept = mean_RT, color = Label),
      inherit.aes = FALSE,
      linetype = "dashed",
      size = 1
    ) +
    geom_point(
      data = df_points,
      aes(x = mean_RT, y = 0, color = Label, shape = Label),
      inherit.aes = FALSE,
      alpha = 0.4,
      size = 3
    ) +
    scale_fill_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
    scale_color_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
    facet_wrap(~ subjectID, nrow = 2, scales = "fixed",
               labeller = labeller(subjectID = setNames(df$label, df$subjectID))) +
    labs(x = "RT (ms)", y = "Density", title = paste0("Group: ", unique(df$groupLabel))) +
    scale_x_continuous(breaks = seq(0, 2000, by = 50)) +
    papaja::theme_apa()
  
  return(p)
})

# plot_RT
plot_RT[[4]]
```

```{r}
pdf("plots_RT.pdf", width = 13, height = 6)
for (plot in plot_list_RT) {
  print(plot)  # 适用于 ggplot2
}
dev.off()
```

### ACC
```{r}
# data processing
emp_bootstrap_cd_ACC_df <- emp_bootstrap_cd_ACC_df %>%
  arrange(as.numeric(subjectID)) %>%
  mutate(
    subjectID = factor(subjectID, levels = unique(subjectID)),
    groupLabel = group_labels[as.character(groupID)],
    label = paste0("Subject ", subjectID)
  )

# 根据 subjID 分组
subject_list_ACC <- split(emp_bootstrap_cd_ACC_df, emp_bootstrap_cd_ACC_df$subjID)

# 按 groupID 分组
emp_bootstrap_ACC_list <- split(emp_bootstrap_cd_ACC_df, emp_bootstrap_cd_ACC_df$groupID)
```

```{r}
# 每个被试画 RT + d 分布
plot_list_ACC <- lapply(subject_list_ACC, function(df) {
  
  # 宽转长
  df_long <- df %>%
    pivot_longer(cols = c(mean_ACC_self, mean_ACC_stranger), names_to = "Label", values_to = "ACC") %>%
    mutate(Label = ifelse(Label == "mean_ACC_self", "self", "stranger"))
  
  # ACC 密度图
  p_acc <- ggplot(df_long, aes(x = ACC, fill = Label, color = Label)) +
    geom_density(alpha = 0.4) +
    scale_fill_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
    scale_color_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
    labs(title = paste0("ACC Density - ", unique(df$subjID), " (", unique(df$groupLabel), ")"),
         x = "ACC", y = "Density") +
    papaja::theme_apa()
  
  # Cohen's d 分布图
  p_d <- ggplot(df, aes(x = Cohen_d_ACC)) +
    geom_density(fill = "#9b8ea9", alpha = 0.5) +
    geom_vline(aes(xintercept = d_lower), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = d_upper), color = "red", linetype = "dashed") +
    labs(title = paste0("Cohen's d ACC Bootstrap - ", unique(df$subjID)),
         x = "Cohen's d ACC", y = "Density") +
    papaja::theme_apa()
  
  # 合并图
  p_acc + p_d
})

# 举例看第一个被试
plot_list_ACC[[1]]
```

```{r}
# 每组按被试分面：Cohen's d 分布
plot_ACC_d <- lapply(emp_bootstrap_ACC_list, function(df) {
  
  df <- df %>%
    mutate(groupLabel = group_labels[as.character(groupID)]) %>%
    mutate(label = paste0("Subject ", subjectID))
  
  ggplot(df, aes(x = Cohen_d_ACC)) +
    geom_density(fill = "steelblue", alpha = 0.5) +
    geom_vline(aes(xintercept = d_lower), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = d_upper), color = "red", linetype = "dashed") +
    geom_vline(aes(xintercept = mean(Cohen_d_ACC)), color = "black", linetype = "solid") +
    facet_wrap(~ subjectID, nrow = 2, scales = "fixed", labeller = labeller(subjectID = setNames(df$label, df$subjectID))) +
    labs(x = "Cohen's d ACC", y = "Density", title = paste0("Group: ", unique(df$groupLabel))) +
    papaja::theme_apa()
})

# plot_RT_d
plot_ACC_d[[4]]
```

```{r}
# 每组按被试分面： ACC 分布 + 加均值线/点
plot_ACC <- lapply(emp_bootstrap_ACC_list, function(df) {
  
  # 加上 group label 和 subject label
  df <- df %>%
    mutate(groupLabel = group_labels[as.character(groupID)]) %>%
    mutate(label = paste0("Subject ", subjectID))
  
  # 宽转长格式 (RT部分)
  df_long <- df %>%
    pivot_longer(cols = c(mean_ACC_self, mean_ACC_stranger),
                 names_to = "Label",
                 values_to = "ACC") %>%
    mutate(Label = ifelse(Label == "mean_ACC_self", "self", "stranger"))
  
  # 提取个体均值（dashed线）
  df_lines <- df_long %>%
    group_by(groupID, subjectID, Label) %>%
    summarise(mean_ACC = mean(ACC, na.rm = TRUE), .groups = "drop")
  
  # 提取组均值（点）
  df_points <- df_long %>%
    group_by(groupID, Label) %>%
    summarise(mean_ACC = mean(ACC, na.rm = TRUE), .groups = "drop")
  
  # 画图
  p <- ggplot(df_long, aes(x = ACC, fill = Label)) +
    geom_density(alpha = 0.4) +
    geom_vline(
      data = df_lines,
      aes(xintercept = mean_ACC, color = Label),
      inherit.aes = FALSE,
      linetype = "dashed",
      size = 1
    ) +
    geom_point(
      data = df_points,
      aes(x = mean_ACC, y = 0, color = Label, shape = Label),
      inherit.aes = FALSE,
      alpha = 0.4,
      size = 3
    ) +
    scale_fill_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
    scale_color_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
    facet_wrap(~ subjectID, nrow = 2, scales = "fixed",
               labeller = labeller(subjectID = setNames(df$label, df$subjectID))) +
    labs(x = "ACC", y = "Density", title = paste0("Group: ", unique(df$groupLabel))) +
    scale_x_continuous(breaks = seq(-1, 1, by = 0.2)) +
    papaja::theme_apa()
  
  return(p)
})

# plot_ACC
plot_ACC[[4]]
```

```{r}
pdf("plots_ACC.pdf", width = 13, height = 5)
for (plot in plot_list_ACC) {
  print(plot)  # 适用于 ggplot2
}
dev.off()
```

## Ridge Plot脊线图
# Data Preprocessing
```{r}
df_emp_individual_wide <- df_individual_wide %>%
  filter(Type == "empirical" & groupID != 7) %>%
  unite(subjID, groupID, subjectID, sep = "_", remove = FALSE) %>%
  select(subjID, groupID, subjectID, cohen_d_RT, cohen_d_ACC)

df_emp_group_wide <- df_group_wide %>%
  filter(Type == "empirical" & groupID != 7) %>%
  select(groupID, cohen_d_RT, cohen_d_ACC)

Condition_order <- c("P=0,T=30,W=300", "P=0,T=30,W=600", "P=120,T=30,W=600", "P=120,T=80,W=600",
                     "P=8,T=100,W=1100", "P=120,T=500,W=1500")

# 确保 groupID 是因子类型，并按照你的顺序排列
df_emp_individual_wide$groupID <- factor(df_emp_individual_wide$groupID, 
                                          levels = c(1, 2, 3, 4, 5, 6))
```

```{r}
# 将 mean_RT_self 和 mean_RT_stranger 转成长格式
emp_bootstrap_RT_long <- emp_bootstrap_cd_RT_df %>%
  select(subjID, groupID, subjectID, mean_RT_self, mean_RT_stranger) %>%
  pivot_longer(cols = c(mean_RT_self, mean_RT_stranger),
               names_to = "label", 
               values_to = "RT_ms") %>%
  mutate(label = ifelse(label == "mean_RT_self", "self", "stranger"))
```

```{r}
# 将 mean_ACC_self 和 mean_ACC_stranger 转成长格式
emp_bootstrap_ACC_long <- emp_bootstrap_cd_ACC_df %>%
  select(subjID, groupID, subjectID, mean_ACC_self, mean_ACC_stranger) %>%
  pivot_longer(cols = c(mean_ACC_self, mean_ACC_stranger),
               names_to = "label", 
               values_to = "ACC") %>%
  mutate(label = ifelse(label == "mean_ACC_self", "self", "stranger"))
```

```{r}
df_emp_group <- df_group %>%
  filter(Type == "empirical" & groupID != 7)

df_emp_individual <- df_individual %>%
  filter(Type == "empirical" & groupID != 7) %>%
  unite(subjID, groupID, subjectID, sep = "_", remove = FALSE)
```

### RT
```{r}
#效应量脊线图
Ridge_cd_RT <- ggplot() +
  # 绘制bootstrap分布（emp_bootstrap_cd_RT_df）
  geom_density_ridges2(
    data = emp_bootstrap_cd_RT_df, 
    aes(x = Cohen_d_RT, y = groupID),
    scale = 0.8,
    fill = "#594c57",
    alpha = 0.6,
    color = NA  # 去掉描边线
  ) +
  # 绘制bootstrap 95%CI（emp_bootstrap_cd_RT_df）
  geom_segment(
    data = group_bootstrap_RT_df,
    aes(x = group_d_lower, xend = group_d_upper, y = groupID, yend = groupID),
    color = "black",
    size = 1.2
  ) +
  # 绘制实证数据个体点（df_emp_individual_wide）
  geom_point(
    data = df_emp_individual_wide, 
    aes(x = cohen_d_RT, y = factor(groupID)),
    shape = "|", 
    size = 3
    ) +
  # 绘制实证数据组均值（df_emp_group_wide）
  geom_point(
    data = df_emp_group_wide,
    aes(x = cohen_d_RT, y = factor(groupID)),
    shape = 16, 
    size = 2.5,
    color = "#ebeee8",
    position = position_nudge(y = 0.1)  # 调整垂直位置，上移0.2单位
  ) +
  scale_x_continuous(
    limits = c(-1, 1.5),  # 设置x轴的显示范围
    breaks = seq(-1.5, 2, by = 0.5)  # 设置x轴每0.5为一个刻度
    ) +
  scale_y_discrete(
    labels = Condition_order  # 设置每个 groupID 对应的标签
  ) +
  labs(
    x = "Cohen's d RT",
    y = "Design"
  ) +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1)

Ridge_cd_RT
```

```{r}
#RT脊线图
Ridge_RT <- ggplot(emp_bootstrap_RT_long) +
  geom_density_ridges(
    aes(x = RT_ms, y = factor(groupID), fill = label),
    scale = 0.8,
    alpha = 0.7,
    color = NA  # 去掉描边线
  ) +
  scale_fill_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
  scale_y_discrete(
    labels = Condition_order  # 设置每个 groupID 对应的标签
  ) +
  labs(
    x = "RT(ms)",
    y = "Design",
    fill = "Label"
  ) +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

Ridge_RT
```

```{r}
# 移除右图的 y 轴元素
Ridge_RT_clean <- Ridge_RT +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

# 左右合并
Combined_Ridge_RT <- Ridge_cd_RT | Ridge_RT_clean

Combined_Ridge_RT
```

### ACC
```{r}
Ridge_cd_ACC <- ggplot() +
  # 绘制分布（emp_bootstrap_cd_ACC_df）
  geom_density_ridges(
    data = emp_bootstrap_cd_ACC_df, 
    aes(x = Cohen_d_ACC, y = groupID),
    scale = 0.8,
    fill = "#594c57",
    alpha = 0.6,
    color = NA  # 去掉描边线
    ) +
  # 绘制bootstrap 95%CI（emp_bootstrap_cd_ACC_df）
  geom_segment(
    data = group_bootstrap_ACC_df,
    aes(x = group_d_lower, xend = group_d_upper, y = groupID, yend = groupID),
    color = "black",
    size = 1.2
  ) +
  # 绘制点（df_emp_individual）
  geom_point(
    data = df_emp_individual_wide, 
    aes(x = cohen_d_ACC, y = factor(groupID)),
    shape = "|", 
    size = 3
    ) +
  # 绘制组均值（df_emp_group_wide）
  geom_point(
    data = df_emp_group_wide,
    aes(x = cohen_d_ACC, y = factor(groupID)),
    shape = 16, 
    size = 2.5,
    color = "#ebeee8",
    position = position_nudge(y = 0.1)  # 调整垂直位置，上移0.2单位
  ) +
  scale_x_continuous(
    limits = c(-1, 3),  # 设置x轴的显示范围
    breaks = seq(-1.5, 3, by = 0.5)  # 设置x轴每0.5为一个刻度
    ) +
  scale_y_discrete(
    labels = Condition_order  # 设置每个 groupID 对应的标签
  ) +
  labs(
    x = "Cohen's d ACC",
    y = "Design"
  ) +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1)

Ridge_cd_ACC
```

```{r}
Ridge_ACC <- ggplot(emp_bootstrap_ACC_long) +
  geom_density_ridges(
    aes(x = ACC, y = factor(groupID), fill = label),
    scale = 0.8,
    alpha = 0.7,
    color = NA  # 去掉描边线
  ) +
  scale_fill_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
  scale_y_discrete(
    labels = Condition_order  # 设置每个 groupID 对应的标签
  ) +
  labs(
    x = "ACC",
    y = "Design",
    fill = "Label"
  ) +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

Ridge_ACC
```

```{r}
# 移除右图的 y 轴元素
Ridge_ACC_clean <- Ridge_ACC +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

# 左右合并
Combined_Ridge_ACC <- Ridge_cd_ACC | Ridge_ACC_clean

Combined_Ridge_ACC
```

### Combine
```{r}
# 只对后面三个图移除 y 轴
Ridge_RT_clean <- Ridge_RT + theme(axis.title.y = element_blank(),
                                   axis.text.y = element_blank(),
                                   axis.ticks.y = element_blank())

Ridge_cd_ACC_clean <- Ridge_cd_ACC + theme(axis.title.y = element_blank(),
                                           axis.text.y = element_blank(),
                                           axis.ticks.y = element_blank())

Ridge_ACC_clean <- Ridge_ACC + theme(axis.title.y = element_blank(),
                                     axis.text.y = element_blank(),
                                     axis.ticks.y = element_blank())

# 拼图
Combined_Ridge <- 
  Ridge_cd_RT + Ridge_RT_clean + Ridge_cd_ACC_clean + Ridge_ACC_clean +
  plot_layout(ncol = 4, guides = "collect") & 
  theme(legend.position = "bottom")

# 显示图
Combined_Ridge
```

```{r}
ggsave("Ridge_s3.png", 
       plot = Combined_Ridge, 
       width = 27, 
       height = 10, 
       dpi = 300)
```

# Parameter
```{r}
condition_labels <- c(
  "1" = "   P=0, T=30, W=300", 
  "2" = "   P=0, T=30, W=600", 
  "3" = "   P=120, T=30, W=600", 
  "4" = "   P=120, T=80, W=600", 
  "5" = "   P=8, T=100, W=1100", 
  "6" = "   P=120, T=500, W=1500"
)
```

## v
### Scar Plot
```{r}
# emp vs sim
diff_v <- ggplot(para_emp_individual, aes(x = factor(groupID), y = v_diff)) +
  # 对实证数据的散点使用 position_jitter 让其围绕模拟数据的点
  geom_point(position = position_jitter(width = 0.2, height = 0.3), 
             color = "#a3bbdb", size = 2.5, alpha = 0.9) +  
  # 在模拟数据上绘制固定的红色点
  geom_point(data = para_sim_group, aes(x = factor(groupID), y = v_diff), 
             color = "#d24735", shape = 17, size = 4.5, alpha = 0.7) +
  labs(
    x = "Condition", 
    y = "v self - v stranger"
  ) +
  scale_x_discrete(labels = condition_labels) + 
  papaja::theme_apa()

diff_v
```

```{r}
ggsave("fastdm_vdiff_vz.png", 
       plot = diff_v, 
       width = 11, 
       height = 5, 
       dpi = 300)
```

```{r}
# emp vs sim
# 让 jitter 可重复（固定随机种子）
set.seed(123)  
# 预先计算 jitter 后的 x 位置
para_emp_long <- para_emp_long %>%
  mutate(x_jitter = as.numeric(factor(label)) + runif(n(), -0.05, 0.05)) 

# 绘图
emp_v <- ggplot(para_emp_long, aes(x = factor(label), y = v)) +
  # 连接线，确保每个 subjectID 连接自己的点
  geom_line(aes(x = x_jitter, group = subjectID), color = "grey70", size = 0.8, alpha = 0.6) +  
  # 绘制 jitter 后的点
  geom_point(aes(x = x_jitter), color = "#a3bbdb", size = 2.5, alpha = 0.9) +
  # 在模拟数据上绘制固定的红色点（仍然使用 factor(label) 以保持对齐）
  geom_point(data = para_sim_group_long, 
             aes(x = factor(label), y = v), 
             inherit.aes = FALSE,
             color = "#d24735", shape = 17, size = 4.5, alpha = 0.7) +
  # 绘制红色线连接模拟数据点
  geom_line(data = para_sim_group_long, 
            aes(group = groupID), 
            color = "#d24735", size = 1.2, alpha = 0.7) + 
  labs(
    x = "Label", 
    y = "v"
  ) +
  # 保持 x 轴显示 "self" 和 "stranger"
  scale_x_discrete(labels = c("self", "stranger")) + 
  facet_wrap(~groupID, labeller = as_labeller(condition_labels)) + 
  papaja::theme_apa()

emp_v
```

```{r}
ggsave("fastdm_v_vz.png", 
       plot = emp_v, 
       width = 9, 
       height = 7, 
       dpi = 300)
```

### Bootstrap(subject level)
只能算subject level，因为被试水平只会有一个参数值
```{r}
# 定义bootstrap函数，计算均值
boot_v <- function(data, indices) {
  d <- data[indices, ]  # 重新抽样数据
  return(mean(d$v_diff))  # 计算均值
}
```

```{r}
# 对每个组进行 bootstrap
set.seed(034)

v_res <- lapply(split(para_emp_individual, para_emp_individual$groupID), function(group_data) {
  boot(data = group_data, statistic = boot_v, R = 5000)  # R 代表重复抽样次数
})

# v_res
```

```{r}
# 转换 bootstrap 结果为 data.frame 以便 ggplot2 可用
v_res_df <- do.call(rbind, lapply(names(v_res), function(group) {
  ci <- boot.ci(v_res[[group]], type = "bca")$bca[4:5]
  data.frame(groupID = group, boot_means = v_res[[group]]$t, lower_ci = ci[1], upper_ci = ci[2])
}))
```

```{r}
# 按分组计算均值和 95% 置信区间
v_res_sum <- v_res_df %>%
  group_by(groupID) %>%
  summarise(
    mean_val = mean(boot_means),
    lower_ci = mean(lower_ci), 
    upper_ci = mean(upper_ci)
  )
```

#### General
```{r}
colors <- RColorBrewer::brewer.pal(6, "RdBu")

vdiff_bootstrap <- ggplot(v_res_df, aes(x = factor(groupID), y = boot_means, fill = factor(groupID))) +
  # 半小提琴图
  stat_halfeye(adjust = 1, justification = -0.3, .width = 0, point_alpha = 0, alpha = 0.7, scale = 0.6) +
  # 透明 bootstrap 散点（叠加在 95% CI 上）
  geom_jitter(aes(color = factor(groupID)), width = 0.1, alpha = 0.1, size = 1.5) +
  # 用 crossbar 画 95% CI
  geom_crossbar(data = v_res_sum, aes(x = factor(groupID), y = mean_val, ymin = lower_ci, ymax = upper_ci), 
                width = 0.15, color = "black", alpha = 0.2) + 
  # 添加 sim_data 的均值点
  geom_point(data = para_sim_group, aes(x = factor(groupID), y = v_diff), 
             color = "black", shape = 17, size = 4) +  
  # 添加 y=0 的虚线
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.8) +
  # 设置调色板
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors) + 
  # 更改 x 轴标签
  scale_x_discrete(labels = condition_labels) + 
  scale_y_continuous(breaks = seq(-1, 6, by = 1)) +
  # 主题设置
  labs(
    x = "Condition",
    y = "Bootstrap Means"
  ) +
  papaja::theme_apa() +
  theme(legend.position = "none") +  # 隐藏图例
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

vdiff_bootstrap
```

```{r}
ggsave("bootstrap_vdiff_vz.png", 
       plot = vdiff_bootstrap, 
       width = 22, 
       height = 7, 
       dpi = 300)
```

#### P effect
```{r}
v_res_df1 <- v_res_df %>%
  filter(groupID == 2 | groupID == 3)
v_res_sum1 <- v_res_sum %>%
  filter(groupID == 2 | groupID == 3)
sim_v_group1 <- para_sim_group %>%
  filter(groupID == 2 | groupID == 3)
```

```{r}
colors <- c("#B61D2F", "#2769AF")

vdiff_bootstrap1 <- ggplot(v_res_df1, aes(x = factor(groupID), y = boot_means, fill = factor(groupID))) +
  # 半小提琴图
  stat_halfeye(adjust = 1, justification = -0.3, .width = 0, point_alpha = 0, alpha = 0.7, scale = 0.6) +
  # 透明 bootstrap 散点（叠加在 95% CI 上）
  geom_jitter(aes(color = factor(groupID)), width = 0.1, alpha = 0.1, size = 1.5) +
  # 用 crossbar 画 95% CI
  geom_crossbar(data = v_res_sum1, aes(x = factor(groupID), y = mean_val, ymin = lower_ci, ymax = upper_ci), 
                width = 0.15, color = "black", alpha = 0.2) + 
  # 添加 sim_data 的均值点
  geom_point(data = sim_v_group1, aes(x = factor(groupID), y = v_diff), 
             color = "black", shape = 17, size = 4) +  
  # 添加 y=0 的虚线
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.8) +
  # 设置调色板
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors) + 
  # 更改 x 轴标签
  scale_x_discrete(labels = condition_labels) + 
  # 主题设置
  labs(
    x = "Condition",
    y = "Bootstrap Means"
  ) +
  papaja::theme_apa() +
  theme(legend.position = "none") +  # 隐藏图例
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )
  
vdiff_bootstrap1
```

```{r}
ggsave("bootstrap_vdiff_vz_P.png", 
       plot = vdiff_bootstrap1, 
       width = 9, 
       height = 5, 
       dpi = 300)
```

#### T effect
```{r}
v_res_df2 <- v_res_df %>%
  filter(groupID == 3 | groupID == 4)
v_res_sum2 <- v_res_sum %>%
  filter(groupID == 3 | groupID == 4)
sim_v_group2 <- para_sim_group %>%
  filter(groupID == 3 | groupID == 4)
```

```{r}
colors <- c("#B61D2F", "#2769AF")

vdiff_bootstrap2 <- ggplot(v_res_df2, aes(x = factor(groupID), y = boot_means, fill = factor(groupID))) +
  # 半小提琴图
  stat_halfeye(adjust = 1, justification = -0.3, .width = 0, point_alpha = 0, alpha = 0.7, scale = 0.6) +
  # 透明 bootstrap 散点（叠加在 95% CI 上）
  geom_jitter(aes(color = factor(groupID)), width = 0.1, alpha = 0.1, size = 1.5) +
  # 用 crossbar 画 95% CI
  geom_crossbar(data = v_res_sum2, aes(x = factor(groupID), y = mean_val, ymin = lower_ci, ymax = upper_ci), 
                width = 0.15, color = "black", alpha = 0.2) + 
  # 添加 sim_data 的均值点
  geom_point(data = sim_v_group2, aes(x = factor(groupID), y = v_diff), 
             color = "black", shape = 17, size = 4) +  
  # 添加 y=0 的虚线
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.8) +
  # 设置调色板
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors) + 
  # 更改 x 轴标签
  scale_x_discrete(labels = condition_labels) + 
  # 主题设置
  labs(
    x = "Condition",
    y = "Bootstrap Means"
  ) +
  papaja::theme_apa() +
  theme(legend.position = "none") +  # 隐藏图例
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )
  
vdiff_bootstrap2
```

```{r}
ggsave("bootstrap_vdiff_vz_T.png", 
       plot = vdiff_bootstrap2, 
       width = 9, 
       height = 5, 
       dpi = 300)
```

####  PT General
```{r}
v_res_df3 <- v_res_df %>%
  filter(groupID == 2 | groupID == 3 | groupID == 4)
v_res_sum3 <- v_res_sum %>%
  filter(groupID == 2 | groupID == 3 | groupID == 4)
sim_v_group3 <- para_sim_group %>%
  filter(groupID == 2 | groupID == 3 | groupID == 4)
```

```{r}
colors <- c("#B61D2F", "#d4d3ca", "#2769AF")

vdiff_bootstrap3 <- ggplot(v_res_df3, aes(x = factor(groupID), y = boot_means, fill = factor(groupID))) +
  # 半小提琴图
  stat_halfeye(adjust = 1, justification = -0.3, .width = 0, point_alpha = 0, alpha = 0.7, scale = 0.6) +
  # 透明 bootstrap 散点（叠加在 95% CI 上）
  geom_jitter(aes(color = factor(groupID)), width = 0.1, alpha = 0.1, size = 1.5) +
  # 用 crossbar 画 95% CI
  geom_crossbar(data = v_res_sum3, aes(x = factor(groupID), y = mean_val, ymin = lower_ci, ymax = upper_ci), 
                width = 0.15, color = "black", alpha = 0.2) + 
  # 添加 sim_data 的均值点
  geom_point(data = sim_v_group3, aes(x = factor(groupID), y = v_diff), 
             color = "black", shape = 17, size = 4) +  
  # 添加 y=0 的虚线
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.8) +
  # 设置调色板
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors) + 
  # 更改 x 轴标签
  scale_x_discrete(labels = condition_labels) + 
  # 主题设置
  labs(
    x = "Condition",
    y = "Bootstrap Means"
  ) +
  papaja::theme_apa() +
  theme(legend.position = "none") +  # 隐藏图例
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )
  
vdiff_bootstrap3
```

```{r}
ggsave("bootstrap_vdiff.png", 
       plot = vdiff_bootstrap3, 
       width = 12, 
       height = 5, 
       dpi = 300)
```

## a
### Bootstrap(subject level)
只能算subject level，因为被试水平只会有一个参数值
```{r}
# 定义bootstrap函数，计算均值
boot_a <- function(data, indices) {
  d <- data[indices, ]  # 重新抽样数据
  return(mean(d$a))  # 计算均值
}
```

```{r}
# 对每个组进行 bootstrap
set.seed(034)

a_res <- lapply(split(para_emp_individual, para_emp_individual$groupID), function(group_data) {
  boot(data = group_data, statistic = boot_a, R = 2000)  # R 代表重复抽样次数
})

# a_res
```

```{r}
# 转换 bootstrap 结果为 data.frame 以便 ggplot2 可用
a_res_df <- do.call(rbind, lapply(names(a_res), function(group) {
  ci <- boot.ci(a_res[[group]], type = "bca")$bca[4:5]
  data.frame(groupID = group, boot_means = a_res[[group]]$t, lower_ci = ci[1], upper_ci = ci[2])
}))
```

```{r}
# 按分组计算均值和 95% 置信区间
a_res_sum <- a_res_df %>%
  group_by(groupID) %>%
  summarise(
    mean_val = mean(boot_means),
    lower_ci = mean(lower_ci), 
    upper_ci = mean(upper_ci)
  )
```

#### General
```{r}
colors <- RColorBrewer::brewer.pal(6, "RdBu")

a_bootstrap <- ggplot(a_res_df, aes(x = factor(groupID), y = boot_means, fill = factor(groupID))) +
  # 半小提琴图
  stat_halfeye(adjust = 1, justification = -0.3, .width = 0, point_alpha = 0, alpha = 0.7, scale = 0.9) +
  # 透明 bootstrap 散点（叠加在 95% CI 上）
  geom_jitter(aes(color = factor(groupID)), width = 0.1, alpha = 0.1, size = 1.5) +
  # 用 crossbar 画 95% CI
  geom_crossbar(data = a_res_sum, aes(x = factor(groupID), y = mean_val, ymin = lower_ci, ymax = upper_ci), 
                width = 0.15, color = "black", alpha = 0.2) + 
  # 添加 sim_data 的均值点
  geom_point(data = para_sim_group, aes(x = factor(groupID), y = a), 
             color = "black", shape = 17, size = 4) +  
  # 设置调色板
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors) + 
  # 更改 x 轴标签
  scale_x_discrete(labels = condition_labels) + 
  # 主题设置
  labs(
    x = "Condition",
    y = "Bootstrap Means"
  ) +
  papaja::theme_apa() +
  theme(legend.position = "none") +  # 隐藏图例
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

a_bootstrap
```

```{r}
ggsave("bootstrap_az.png", 
       plot = a_bootstrap, 
       width = 22, 
       height = 7, 
       dpi = 300)
```

#### W effect
```{r}
a_res_df1 <- a_res_df %>%
  filter(groupID == 1 | groupID == 2)
a_res_sum1 <- a_res_sum %>%
  filter(groupID == 1 | groupID == 2)
sim_a_group1 <- para_sim_group %>%
  filter(groupID == 1 | groupID == 2)
```

```{r}
colors <- c("#B61D2F", "#2769AF")

a_bootstrap1 <- ggplot(a_res_df1, aes(x = factor(groupID), y = boot_means, fill = factor(groupID))) +
  # 半小提琴图
  stat_halfeye(adjust = 1, justification = -0.3, .width = 0, point_alpha = 0, alpha = 0.7, scale = 0.9) +
  # 透明 bootstrap 散点（叠加在 95% CI 上）
  geom_jitter(aes(color = factor(groupID)), width = 0.1, alpha = 0.1, size = 1.5) +
  # 用 crossbar 画 95% CI
  geom_crossbar(data = a_res_sum1, aes(x = factor(groupID), y = mean_val, ymin = lower_ci, ymax = upper_ci), 
                width = 0.15, color = "black", alpha = 0.2) + 
  # 添加 sim_data 的均值点
  geom_point(data = sim_a_group1, aes(x = factor(groupID), y = a), 
             color = "black", shape = 17, size = 4) +  
  # 设置调色板
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors) + 
  # 更改 x 轴标签
  scale_x_discrete(labels = condition_labels) + 
  # 主题设置
  labs(
    x = "Condition",
    y = "Bootstrap Means"
  ) +
  papaja::theme_apa() +
  theme(legend.position = "none")  # 隐藏图例

a_bootstrap1
```

```{r}
ggsave("bootstrap_az_W.png", 
       plot = a_bootstrap1, 
       width = 7, 
       height = 5, 
       dpi = 300)
```

#### T effect
```{r}
a_res_df2 <- a_res_df %>%
  filter(groupID == 3 | groupID == 4)
a_res_sum2 <- a_res_sum %>%
  filter(groupID == 3 | groupID == 4)
sim_a_group2 <- para_sim_group %>%
  filter(groupID == 3 | groupID == 4)
```

```{r}
colors <- c("#B61D2F", "#2769AF")

a_bootstrap2 <- ggplot(a_res_df2, aes(x = factor(groupID), y = boot_means, fill = factor(groupID))) +
  # 半小提琴图
  stat_halfeye(adjust = 1, justification = -0.3, .width = 0, point_alpha = 0, alpha = 0.7, scale = 0.9) +
  # 透明 bootstrap 散点（叠加在 95% CI 上）
  geom_jitter(aes(color = factor(groupID)), width = 0.1, alpha = 0.1, size = 1.5) +
  # 用 crossbar 画 95% CI
  geom_crossbar(data = a_res_sum2, aes(x = factor(groupID), y = mean_val, ymin = lower_ci, ymax = upper_ci), 
                width = 0.15, color = "black", alpha = 0.2) + 
  # 添加 sim_data 的均值点
  geom_point(data = sim_a_group2, aes(x = factor(groupID), y = a), 
             color = "black", shape = 17, size = 4) +  
  # 设置调色板
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors) + 
  # 更改 x 轴标签
  scale_x_discrete(labels = condition_labels) + 
  # 主题设置
  labs(
    x = "Condition",
    y = "Bootstrap Means"
  ) +
  papaja::theme_apa() +
  theme(legend.position = "none")  # 隐藏图例

a_bootstrap2
```

```{r}
ggsave("bootstrap_az_T.png", 
       plot = a_bootstrap2, 
       width = 7, 
       height = 5, 
       dpi = 300)
```

#### WT General
```{r}
a_res_df3 <- a_res_df %>%
  filter(groupID == 1 | groupID == 2 | groupID == 3 | groupID == 4)
a_res_sum3 <- a_res_sum %>%
  filter(groupID == 1 | groupID == 2 | groupID == 3 | groupID == 4)
sim_a_group3 <- para_sim_group %>%
  filter(groupID == 1 | groupID == 2 | groupID == 3 | groupID == 4)
```

```{r}
colors <- RColorBrewer::brewer.pal(4, "RdBu")

a_bootstrap3 <- ggplot(a_res_df3, aes(x = factor(groupID), y = boot_means, fill = factor(groupID))) +
  # 半小提琴图
  stat_halfeye(adjust = 1, justification = -0.3, .width = 0, point_alpha = 0, alpha = 0.7, scale = 0.9) +
  # 透明 bootstrap 散点（叠加在 95% CI 上）
  geom_jitter(aes(color = factor(groupID)), width = 0.1, alpha = 0.1, size = 1.5) +
  # 用 crossbar 画 95% CI
  geom_crossbar(data = a_res_sum3, aes(x = factor(groupID), y = mean_val, ymin = lower_ci, ymax = upper_ci), 
                width = 0.15, color = "black", alpha = 0.2) + 
  # 添加 sim_data 的均值点
  geom_point(data = sim_a_group3, aes(x = factor(groupID), y = a), 
             color = "black", shape = 17, size = 4) +  
  # 设置调色板
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors) + 
  # 更改 x 轴标签
  scale_x_discrete(labels = condition_labels) + 
  scale_y_continuous(breaks = seq(-1, 3, by = 0.5)) +
  # 主题设置
  labs(
    x = "Condition",
    y = "Bootstrap Means"
  ) +
  papaja::theme_apa() +
  theme(legend.position = "none") + # 隐藏图例
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )
  
a_bootstrap3
```

```{r}
ggsave("bootstrap_a.png", 
       plot = a_bootstrap3, 
       width = 15, 
       height = 5, 
       dpi = 300)
```

# Mask Contrast
```{r}
maskcontrast_group <- df_group %>%
  filter(Type == "empirical") %>%
  filter(groupID == 5 | groupID == 7)

maskcontrast_individual <- df_individual %>%
  filter(Type == "empirical") %>%
  filter(groupID == 5 | groupID == 7)
```

```{r}
emp_bootstrap_mask <- df_emp_match %>%
  filter(!is.na(RT_ms)) %>%
  filter(groupID == 5 | groupID == 7) %>%
  mutate(
    uniqueID = paste(groupID, subjectID, Label, sep = "_"),
    subjID = paste(groupID, subjectID, sep = "_")
    )
```

## Return Cohen's d
### RT
```{r}
# bootstrap过程
set.seed(522)

emp_bootstrap_mask_RT <- lapply(split(emp_bootstrap_mask, emp_bootstrap_mask$groupID), function(group_data) {
  boot(data = as.data.frame(group_data), statistic = function(data, indices) {
    
    # 获取每个被试的数据
    sampled_data <- data[indices, ]
    
    # 按照 label 分组 (self 和 stranger)
    group_self <- sampled_data[sampled_data$Label == "self", "RT_ms"]
    group_stranger <- sampled_data[sampled_data$Label == "stranger", "RT_ms"]
    
    # 计算 mean_RT 和 sd_RT
    mean_RT_self <- mean(group_self, na.rm = TRUE)
    mean_RT_stranger <- mean(group_stranger, na.rm = TRUE)
    sd_RT_self <- sd(group_self, na.rm = TRUE)
    sd_RT_stranger <- sd(group_stranger, na.rm = TRUE)
    
    # 计算 Cohen's d RT: stranger - self
    d <- (mean_RT_stranger - mean_RT_self) / 
      sqrt(((length(group_stranger) - 1) * sd_RT_stranger^2 + (length(group_self) - 1) * sd_RT_self^2) / (length(group_self) + length(group_stranger) - 2))
    
    return(c(mean_RT_self = mean_RT_self, mean_RT_stranger = mean_RT_stranger, cohen_d = d))
  }, R = 5000)
})

# emp_bootstrap_cd_RT
```

```{r}
# 提取 bootstrap 结果 + 95% CI
emp_bootstrap_mask_RT_df <- do.call(rbind, lapply(seq_along(emp_bootstrap_mask_RT), function(i) {
  boot_obj <- emp_bootstrap_mask_RT[[i]]
  groupID <- names(emp_bootstrap_mask_RT)[i]
  
  # 提取 95% CI for cohen_d
  ci <- tryCatch({
    boot.ci(boot_obj, type = "perc", index = 3)$perc[4:5]
  }, error = function(e) c(NA, NA))  # 防止个别被试失败（例如方差为0）

  # 每次抽样的结果
  df <- as.data.frame(boot_obj$t) %>%
    setNames(c("mean_RT_self", "mean_RT_stranger", "Cohen_d_RT")) %>%
    mutate(
      d_lower = ci[1],
      d_upper = ci[2],
      groupID = groupID
    )
  return(df)
}))
```

### ACC
```{r}
# bootstrap过程
set.seed(522)

emp_bootstrap_mask_ACC <- lapply(split(emp_bootstrap_mask, emp_bootstrap_mask$groupID), function(group_data) {
  boot(data = as.data.frame(group_data), statistic = function(data, indices) {
    
    # 获取每个被试的数据
    sampled_data <- data[indices, ]
    
    # 按照 label 分组 (self 和 stranger)
    group_self <- sampled_data[sampled_data$Label == "self", "Correct"]
    group_stranger <- sampled_data[sampled_data$Label == "stranger", "Correct"]
    
    # 计算 mean_ACC 和 sd_ACC
    mean_ACC_self <- mean(group_self == 1, na.rm = TRUE)
    mean_ACC_stranger <- mean(group_stranger == 1, na.rm = TRUE)
    sd_ACC_self <- sd(group_self == 1, na.rm = TRUE)
    sd_ACC_stranger <- sd(group_stranger == 1, na.rm = TRUE)
    
    # 计算 Cohen's d ACC: self - stranger
    d <- (mean_ACC_self - mean_ACC_stranger) / 
      sqrt(((length(group_stranger) - 1) * sd_ACC_stranger^2 + (length(group_self) - 1) * sd_ACC_self^2) / 
           (length(group_self) + length(group_stranger) - 2))
    
    return(c(mean_ACC_self = mean_ACC_self, mean_ACC_stranger = mean_ACC_stranger, cohen_d = d))
  }, R = 5000)
})

# emp_bootstrap_cd_ACC
```

```{r}
# 提取 bootstrap 结果 + 95% CI
emp_bootstrap_mask_ACC_df <- do.call(rbind, lapply(seq_along(emp_bootstrap_mask_ACC), function(i) {
  boot_obj <- emp_bootstrap_mask_ACC[[i]]
  groupID <- names(emp_bootstrap_mask_ACC)[i]
  
  # 提取 95% CI for cohen_d
  ci <- tryCatch({
    boot.ci(boot_obj, type = "perc", index = 3)$perc[4:5]
  }, error = function(e) c(NA, NA))  # 防止个别被试失败（例如方差为0）

  # 每次抽样的结果
  df <- as.data.frame(boot_obj$t) %>%
    setNames(c("mean_ACC_self", "mean_ACC_stranger", "Cohen_d_ACC")) %>%
    mutate(
      d_lower = ci[1],
      d_upper = ci[2],
      groupID = groupID
    )
  return(df)
}))
```

## Ridge Plot
```{r}
df_emp_individual_wide_mask <- df_individual_wide %>%
  filter(Type == "empirical") %>%
  filter(groupID == 5 | groupID == 7) %>%
  unite(subjID, groupID, subjectID, sep = "_", remove = FALSE) %>%
  select(subjID, groupID, subjectID, cohen_d_RT, cohen_d_ACC)

df_emp_group_wide_mask <- df_group_wide %>%
  filter(Type == "empirical") %>%
  filter(groupID == 5 | groupID == 7) %>%
  select(groupID, cohen_d_RT, cohen_d_ACC)

Condition_order <- c("mask", "no mask")

# 确保 groupID 是因子类型，并按照你的顺序排列
df_emp_group_wide_mask$groupID <- factor(df_emp_group_wide_mask$groupID, 
                                          levels = c(5, 7))
```

```{r}
# 将 mean_RT_self 和 mean_RT_stranger 转成长格式
emp_bootstrap_mask_RT_long <- emp_bootstrap_mask_RT_df %>%
  select(groupID, mean_RT_self, mean_RT_stranger) %>%
  pivot_longer(cols = c(mean_RT_self, mean_RT_stranger),
               names_to = "label", 
               values_to = "RT_ms") %>%
  mutate(label = ifelse(label == "mean_RT_self", "self", "stranger"))
```

```{r}
# 将 mean_ACC_self 和 mean_ACC_stranger 转成长格式
emp_bootstrap_mask_ACC_long <- emp_bootstrap_mask_ACC_df %>%
  select(groupID, mean_ACC_self, mean_ACC_stranger) %>%
  pivot_longer(cols = c(mean_ACC_self, mean_ACC_stranger),
               names_to = "label", 
               values_to = "ACC") %>%
  mutate(label = ifelse(label == "mean_ACC_self", "self", "stranger"))
```

### Design
#### RT
```{r}
Ridge_cd_RT <- ggplot() +
  # 绘制分布（emp_bootstrap_cd_RT_df）
  geom_density_ridges2(
    data = emp_bootstrap_mask_RT_df, 
    aes(x = Cohen_d_RT, y = groupID),
    scale = .9,
    fill = "#594c57",
    alpha = 0.6,
    color = NA  # 去掉描边线
    ) +
  scale_x_continuous(
    limits = c(0, 1.0),  # 设置x轴的显示范围
    breaks = seq(-1.5, 2, by = 0.5)  # 设置x轴每0.5为一个刻度
    ) +
  scale_y_discrete(
    labels = Condition_order  # 设置每个 groupID 对应的标签
  ) +
  labs(
    x = "Cohen's d RT",
    y = "Design"
  ) +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

Ridge_cd_RT
```

```{r}
Ridge_RT <- ggplot(emp_bootstrap_mask_RT_long) +
  geom_density_ridges(
    aes(x = RT_ms, y = factor(groupID), fill = label),
    scale = 1,
    alpha = 0.7,
    color = NA  # 去掉描边线
  ) +
  scale_fill_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
  scale_x_continuous(
    limits = c(600, 770),  # 设置x轴的显示范围
    breaks = seq(600, 770, by = 50)  # 设置x轴每0.5为一个刻度
    ) +
  scale_y_discrete(
    labels = Condition_order  # 设置每个 groupID 对应的标签
  ) +
  labs(
    x = "RT(ms)",
    y = "Design",
    fill = "Label"
  ) +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

Ridge_RT
```

```{r}
# 移除右图的 y 轴元素
Ridge_RT_clean <- Ridge_RT +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

# 左右合并
Combined_Ridge_RT <- Ridge_cd_RT | Ridge_RT_clean

Combined_Ridge_RT
```

```{r}
ggsave("Ridge_RT_mask.png", 
       plot = Combined_Ridge_RT, 
       width = 15, 
       height = 7, 
       dpi = 300)
```

#### ACC
```{r}
Ridge_cd_ACC <- ggplot() +
  # 绘制分布（emp_bootstrap_cd_ACC_df）
  geom_density_ridges(
    data = emp_bootstrap_mask_ACC_df, 
    aes(x = Cohen_d_ACC, y = groupID),
    scale = .9,
    fill = "#594c57",
    alpha = 0.6,
    color = NA  # 去掉描边线
    ) +
  scale_x_continuous(
    limits = c(0, 1),  # 设置x轴的显示范围
    breaks = seq(-1.5, 2, by = 0.5)  # 设置x轴每0.5为一个刻度
    ) +
  scale_y_discrete(
    labels = Condition_order  # 设置每个 groupID 对应的标签
  ) +
  labs(
    x = "Cohen's d ACC",
    y = "Design"
  ) +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

Ridge_cd_ACC
```

```{r}
Ridge_ACC <- ggplot(emp_bootstrap_mask_ACC_long) +
  geom_density_ridges(
    aes(x = ACC, y = factor(groupID), fill = label),
    scale = 1,
    alpha = 0.7,
    color = NA  # 去掉描边线
  ) +
  scale_fill_manual(values = c("self" = "#12264f", "stranger" = "#a72126")) +
  scale_x_continuous(
    limits = c(0.6, 1.0),  # 设置x轴的显示范围
    breaks = seq(0.6, 1.0, by = 0.1)  # 设置x轴每0.5为一个刻度
    ) +
  scale_y_discrete(
    labels = Condition_order  # 设置每个 groupID 对应的标签
  ) +
  labs(
    x = "ACC",
    y = "Design",
    fill = "Label"
  ) +
  papaja::theme_apa() +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", color = "black"),
    axis.title.y = element_text(size = 20, face = "bold", color = "black"),
    axis.text.x  = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y  = element_text(size = 21, face = "bold", color = "black"),
    strip.text   = element_text(size = 20, face = "bold", color = "black"),
    legend.title = element_text(size = 21, face = "bold", color = "black"),
    legend.text  = element_text(size = 20, face = "bold", color = "black")
  )

Ridge_ACC
```

```{r}
# 移除右图的 y 轴元素
Ridge_ACC_clean <- Ridge_ACC +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

# 左右合并
Combined_Ridge_ACC <- Ridge_cd_ACC | Ridge_ACC_clean

Combined_Ridge_ACC
```

```{r}
ggsave("Ridge_ACC_mask.png", 
       plot = Combined_Ridge_ACC, 
       width = 11, 
       height = 7, 
       dpi = 300)
```

```{r}
# 只对后面三个图移除 y 轴
Ridge_RT_clean <- Ridge_RT + theme(axis.title.y = element_blank(),
                                   axis.text.y = element_blank(),
                                   axis.ticks.y = element_blank())

Ridge_cd_ACC_clean <- Ridge_cd_ACC + theme(axis.title.y = element_blank(),
                                           axis.text.y = element_blank(),
                                           axis.ticks.y = element_blank())

Ridge_ACC_clean <- Ridge_ACC + theme(axis.title.y = element_blank(),
                                     axis.text.y = element_blank(),
                                     axis.ticks.y = element_blank())

# 拼图
Combined_Ridge <- 
  Ridge_cd_RT + Ridge_RT_clean + Ridge_cd_ACC_clean + Ridge_ACC_clean +
  plot_layout(ncol = 4, guides = "collect") & 
  theme(legend.position = "bottom")

# 显示图
Combined_Ridge
```

```{r}
ggsave("Ridge_mask.png", 
       plot = Combined_Ridge, 
       width = 14, 
       height = 5, 
       dpi = 300)
```